NpbmcgU3lzdGVtOwp1c2luZyBTeXN0ZW0uSU87CnVzaW5nIE91dGxvb2sgPSBNaWNyb3NvZnQuT2ZmaWNlLkludGVyb3AuT3V0bG9vazsKCnB1YmxpYyBjbGFzcyBPdXRsb29rRW1haWxNb3Zlcgp7CiAgICBwdWJsaWMgc3RyaW5nIE1vdmVFbWFpbHMoCiAgICAgICAgc3RyaW5nIG1haWxib3hOYW1lLAogICAgICAgIHN0cmluZyBzb3VyY2VGb2xkZXIsCiAgICAgICAgc3RyaW5nIGRlc3RpbmF0aW9uRm9sZGVyLAogICAgICAgIHN0cmluZyBtYWlsTW92ZVN0YXR1cywKICAgICAgICBzdHJpbmcgc3ViamVjdCwKICAgICAgICBzdHJpbmcgZGVzdEZvbGRlclBhdGgpCiAgICB7CiAgICAgICAgc3RyaW5nIGxvZ0ZpbGUgPSBCdWlsZExvZ0ZpbGVOYW1lKCk7CiAgICAgICAgTG9nKGxvZ0ZpbGUsICJbSU5GT10gQyMgRW1haWwgTW92ZSBTdGFydGluZy4uLiIpOwoKICAgICAgICB0cnkKICAgICAgICB7CiAgICAgICAgICAgIC8vIEF0dGFjaCB0byBPdXRsb29rCiAgICAgICAgICAgIE91dGxvb2suQXBwbGljYXRpb24gYXBwID0KICAgICAgICAgICAgICAgIChPdXRsb29rLkFwcGxpY2F0aW9uKVN5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlcy5NYXJzaGFsCiAgICAgICAgICAgICAgICAuR2V0QWN0aXZlT2JqZWN0KCJPdXRsb29rLkFwcGxpY2F0aW9uIik7CgogICAgICAgICAgICBPdXRsb29rLk5hbWVTcGFjZSBucyA9IGFwcC5HZXROYW1lc3BhY2UoIk1BUEkiKTsKCiAgICAgICAgICAgIE91dGxvb2suTUFQSUZvbGRlciBtYWlsYm94ID0gbnMuRm9sZGVyc1ttYWlsYm94TmFtZV07CgogICAgICAgICAgICBpZiAobWFpbGJveCA9PSBudWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBMb2cobG9nRmlsZSwgIltFUlJPUl0gTWFpbGJveCBub3QgZm91bmQ6ICIgKyBtYWlsYm94TmFtZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gIk1haWxib3ggbm90IGZvdW5kIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU291cmNlIGZvbGRlcgogICAgICAgICAgICBPdXRsb29rLk1BUElGb2xkZXIgc3JjRm9sZGVyID0gRW5zdXJlRm9sZGVyRXhpc3RzKG1haWxib3gsIHNvdXJjZUZvbGRlciwgbG9nRmlsZSk7CiAgICAgICAgICAgIC8vIERlc3RpbmF0aW9uIGZvbGRlcgogICAgICAgICAgICBPdXRsb29rLk1BUElGb2xkZXIgZGVzdEZvbGRlciA9IEVuc3VyZUZvbGRlckV4aXN0cyhtYWlsYm94LCBkZXN0aW5hdGlvbkZvbGRlciwgbG9nRmlsZSk7CgogICAgICAgICAgICBpZiAoc3JjRm9sZGVyID09IG51bGwgfHwgZGVzdEZvbGRlciA9PSBudWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBMb2cobG9nRmlsZSwgIltFUlJPUl0gU291cmNlL0Rlc3RpbmF0aW9uIGZvbGRlciBtaXNzaW5nLiIpOwogICAgICAgICAgICAgICAgcmV0dXJuICJTb3VyY2Ugb3IgRGVzdGluYXRpb24gZm9sZGVyIGRvZXMgbm90IGV4aXN0IjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgTG9nKGxvZ0ZpbGUsICQiW0lORk9dIFNvdXJjZSBGb2xkZXI6IHtzb3VyY2VGb2xkZXJ9IC0gQ291bnQ6IHtzcmNGb2xkZXIuSXRlbXMuQ291bnR9Iik7CiAgICAgICAgICAgIExvZyhsb2dGaWxlLCAkIltJTkZPXSBEZXN0IEZvbGRlcjogICB7ZGVzdGluYXRpb25Gb2xkZXJ9Iik7CgogICAgICAgICAgICAvLyBMb29wIHRocm91Z2ggbWVzc2FnZXMKICAgICAgICAgICAgZm9yIChpbnQgaSA9IHNyY0ZvbGRlci5JdGVtcy5Db3VudDsgaSA+PSAxOyBpLS0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBpdGVtID0gc3JjRm9sZGVyLkl0ZW1zW2ldOwoKICAgICAgICAgICAgICAgIGlmIChpdGVtIGlzIE91dGxvb2suTWFpbEl0ZW0gbWFpbCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBNYXRjaGVzIFZCU2NyaXB0IGF1dG8tcmVwbHkgZmlsdGVycwogICAgICAgICAgICAgICAgICAgIGlmIChtYWlsLlN1YmplY3QgIT0gbnVsbCAmJgogICAgICAgICAgICAgICAgICAgICAgICBtYWlsLlN1YmplY3QuVG9Mb3dlcigpLkNvbnRhaW5zKCJ1bmRlbGl2ZXJhYmxlIikgPT0gZmFsc2UgJiYKICAgICAgICAgICAgICAgICAgICAgICAgbWFpbC5TdWJqZWN0LlRvTG93ZXIoKS5Db250YWlucygiYXV0b21hdGljIHJlcGx5IikgPT0gZmFsc2UpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdWJqZWN0IGZpbHRlciAoc2FtZSBWQlNjcmlwdCBiZWhhdmlvcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1haWwuU3ViamVjdCAhPSBudWxsICYmIG1haWwuU3ViamVjdC5UcmltKCkuQ29udGFpbnMoc3ViamVjdCkpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZyhsb2dGaWxlLCAiW0lORk9dIE1vdmluZyBlbWFpbDogIiArIG1haWwuU3ViamVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWlsLk1vdmUoZGVzdEZvbGRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWlsTW92ZVN0YXR1cyA9ICJNYWlsIE1vdmVkOiAiICsgbWFpbC5TdWJqZWN0OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nKGxvZ0ZpbGUsICJbSU5GT10gU3ViamVjdCBtaXNtYXRjaCwgc2tpcHBpbmc6ICIgKyBtYWlsLlN1YmplY3QpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBMb2cobG9nRmlsZSwgIltJTkZPXSBDT01QTEVURUQgZW1haWwgbW92ZSBwcm9jZXNzLiIpOwogICAgICAgICAgICByZXR1cm4gbWFpbE1vdmVTdGF0dXM7CiAgICAgICAgfQogICAgICAgIGNhdGNoIChFeGNlcHRpb24gZXgpCiAgICAgICAgewogICAgICAgICAgICBMb2cobG9nRmlsZSwgIltFUlJPUl0gIiArIGV4Lk1lc3NhZ2UpOwogICAgICAgICAgICByZXR1cm4gIkVycm9yIG1vdmluZyBlbWFpbDogIiArIGV4Lk1lc3NhZ2U7CiAgICAgICAgfQogICAgfQoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gSGVscGVyOiBFbnN1cmUgRm9sZGVyIEV4aXN0cyAoc2FtZSBsb2dpYyBhcyBWQlNjcmlwdCkKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgcHJpdmF0ZSBPdXRsb29rLk1BUElGb2xkZXIgRW5zdXJlRm9sZGVyRXhpc3RzKAogICAgICAgIE91dGxvb2suTUFQSUZvbGRlciBwYXJlbnQsCiAgICAgICAgc3RyaW5nIGZvbGRlck5hbWUsCiAgICAgICAgc3RyaW5nIGxvZ0ZpbGUpCiAgICB7CiAgICAgICAgZm9yZWFjaCAoT3V0bG9vay5NQVBJRm9sZGVyIGYgaW4gcGFyZW50LkZvbGRlcnMpCiAgICAgICAgewogICAgICAgICAgICBpZiAoZi5OYW1lLkVxdWFscyhmb2xkZXJOYW1lLCBTdHJpbmdDb21wYXJpc29uLk9yZGluYWxJZ25vcmVDYXNlKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIGY7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEZvbGRlciBtaXNzaW5nIOKGkiBWQlNjcmlwdCBhdXRvLWNyZWF0ZXMgaXQKICAgICAgICBMb2cobG9nRmlsZSwgIltJTkZPXSBDcmVhdGluZyBtaXNzaW5nIGZvbGRlcjogIiArIGZvbGRlck5hbWUpOwoKICAgICAgICByZXR1cm4gcGFyZW50LkZvbGRlcnMuQWRkKGZvbGRlck5hbWUpOwogICAgfQoKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gSGVscGVyOiBMb2cgZmlsZSBjcmVhdGlvbgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBwcml2YXRlIHN0cmluZyBCdWlsZExvZ0ZpbGVOYW1lKCkKICAgIHsKICAgICAgICBzdHJpbmcgdGltZXN0YW1wID0KICAgICAgICAgICAgJCJ7RGF0ZVRpbWUuTm93Onl5eXlNTWRkX0hIbW1zc30iOwogICAgICAgIHN0cmluZyBmaWxlID0gJCJDOlxcVEVNUFxcQ1NfRW1haWxfTW92ZV97dGltZXN0YW1wfS5sb2ciOwoKICAgICAgICByZXR1cm4gZmlsZTsKICAgIH0KCiAgICBwcml2YXRlIHZvaWQgTG9nKHN0cmluZyBmaWxlLCBzdHJpbmcgbWVzc2FnZSkKICAgIHsKICAgICAgICB1c2luZyAoU3RyZWFtV3JpdGVyIHN3ID0gbmV3IFN0cmVhbVdyaXRlcihmaWxlLCB0cnVlKSkKICAgICAgICB7CiAgICAgICAgICAgIHN3LldyaXRlTGluZSgkIntEYXRlVGltZS5Ob3c6eXl5eS1NTS1kZCBISDptbTpzc30ge21lc3NhZ2V9Iik7CiAgICAgICAgfQogICAgfQp9