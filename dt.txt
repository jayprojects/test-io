import microsoft.exchange.webservices.data.core.ExchangeService;
import microsoft.exchange.webservices.data.core.enumeration.misc.ExchangeVersion;
import microsoft.exchange.webservices.data.core.enumeration.property.BasePropertySet;
import microsoft.exchange.webservices.data.core.enumeration.property.BodyType;
import microsoft.exchange.webservices.data.core.enumeration.service.ConflictResolutionMode;
import microsoft.exchange.webservices.data.core.enumeration.service.WellKnownFolderName;
import microsoft.exchange.webservices.data.core.service.item.EmailMessage;
import microsoft.exchange.webservices.data.credential.WebCredentials;
import microsoft.exchange.webservices.data.property.complex.MessageBody;
import microsoft.exchange.webservices.data.property.definition.PropertySet;
import microsoft.exchange.webservices.data.search.FindItemsResults;
import microsoft.exchange.webservices.data.search.ItemView;
import microsoft.exchange.webservices.data.search.filter.SearchFilter;
import microsoft.exchange.webservices.data.core.service.schema.EmailMessageSchema;
import microsoft.exchange.webservices.data.core.service.item.Item;

import java.net.URI;
import java.util.ArrayList;
import java.util.List;

public class EwsMailClient {

    /**
     * Create and configure an ExchangeService for EWS.
     *
     * @param ewsUrl    e.g. https://mail.company.com/EWS/Exchange.asmx
     * @param username  often a UPN/email (user@domain) or DOMAIN\\user depending on your Exchange config
     * @param password  password for the mailbox/user
     */
    public static ExchangeService connect(String ewsUrl, String username, String password) throws Exception {
        ExchangeService service = new ExchangeService(ExchangeVersion.Exchange2010_SP2);

        // Credentials (avoid hardcoding password; load from env/secret store in real apps)
        service.setCredentials(new WebCredentials(username, password));

        // EWS endpoint
        service.setUrl(new URI(ewsUrl));

        // Optional: enable tracing for debugging (DO NOT enable in production with secrets in logs)
        // service.setTraceEnabled(true);

        return service;
    }

    /**
     * Send an email (and save a copy to Sent Items).
     */
    public static void sendEmail(
            ExchangeService service,
            List<String> toRecipients,
            String subject,
            String body,
            boolean bodyIsHtml
    ) throws Exception {

        EmailMessage msg = new EmailMessage(service);

        for (String to : toRecipients) {
            msg.getToRecipients().add(to);
        }

        msg.setSubject(subject);

        BodyType bt = bodyIsHtml ? BodyType.HTML : BodyType.Text;
        msg.setBody(new MessageBody(bt, body));

        // Sends the message and saves a copy in Sent Items
        msg.sendAndSaveCopy();
    }

    /**
     * Fetch the latest messages from Inbox.
     *
     * @param maxCount   max number of items to fetch
     * @param unreadOnly if true, returns only unread messages
     */
    public static List<EmailMessage> readInbox(
            ExchangeService service,
            int maxCount,
            boolean unreadOnly
    ) throws Exception {

        ItemView view = new ItemView(maxCount);

        FindItemsResults<Item> results;
        if (unreadOnly) {
            SearchFilter unreadFilter =
                    new SearchFilter.IsEqualTo(EmailMessageSchema.IsRead, false);
            results = service.findItems(WellKnownFolderName.Inbox, unreadFilter, view);
        } else {
            results = service.findItems(WellKnownFolderName.Inbox, view);
        }

        // Ensure we load useful fields like subject, from, body, etc.
        PropertySet props = new PropertySet(BasePropertySet.FirstClassProperties);
        props.setRequestedBodyType(BodyType.Text); // change to HTML if you want

        List<EmailMessage> emails = new ArrayList<>();
        for (Item item : results.getItems()) {
            EmailMessage email = EmailMessage.bind(service, item.getId(), props);
            emails.add(email);
        }
        return emails;
    }

    /**
     * Mark a message as read.
     */
    public static void markAsRead(EmailMessage email) throws Exception {
        email.setIsRead(true);
        email.update(ConflictResolutionMode.AlwaysOverwrite);
    }

    // Example usage
    public static void main(String[] args) throws Exception {
        String ewsUrl = "https://your-server/EWS/Exchange.asmx";
        String username = "user@company.com";
        String password = System.getenv("EWS_PASSWORD"); // recommended

        ExchangeService service = connect(ewsUrl, username, password);

        // Send
        sendEmail(
                service,
                List.of("someone@example.com"),
                "Test from EWS Java",
                "<b>Hello</b> from EWS",
                true
        );

        // Read (latest 10 unread)
        List<EmailMessage> unread = readInbox(service, 10, true);
        for (EmailMessage m : unread) {
            System.out.println("Subject: " + m.getSubject());
            System.out.println("From: " + (m.getFrom() != null ? m.getFrom().getAddress() : "(unknown)"));
            System.out.println("Body: " + (m.getBody() != null ? m.getBody().toString() : ""));
            System.out.println("-----");

            // markAsRead(m);
        }
    }
}
