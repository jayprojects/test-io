import microsoft.exchange.webservices.data.core.enumeration.misc.ExchangeVersion;
import microsoft.exchange.webservices.data.core.enumeration.property.BasePropertySet;
import microsoft.exchange.webservices.data.core.enumeration.property.BodyType;
import microsoft.exchange.webservices.data.core.enumeration.service.WellKnownFolderName;
import microsoft.exchange.webservices.data.core.service.item.EmailMessage;
import microsoft.exchange.webservices.data.core.service.item.Item;
import microsoft.exchange.webservices.data.core.service.schema.EmailMessageSchema;
import microsoft.exchange.webservices.data.property.definition.PropertySet;
import microsoft.exchange.webservices.data.search.FindItemsResults;
import microsoft.exchange.webservices.data.search.ItemView;
import microsoft.exchange.webservices.data.search.filter.SearchFilter;

public class EwsMailClient {

    /**
     * Read a particular email from Inbox by EXACT subject match.
     *
     * Notes:
     * - EWS "Subject" is typically the displayed subject (may include prefixes like "RE:" / "FW:")
     * - If there are multiple matches, this returns the first found (you can expand to return a list).
     *
     * @param service     connected ExchangeService
     * @param exactSubject subject to match exactly (case-sensitive behavior depends on server; often case-insensitive)
     * @param unreadOnly  if true, only match unread messages
     * @param maxSearch   how many recent items to scan (e.g., 50/200)
     * @param bodyType    BodyType.Text or BodyType.HTML for requested body format
     * @return EmailMessage with full properties loaded, or null if not found
     */
    public static EmailMessage readEmailByExactSubject(
            microsoft.exchange.webservices.data.core.ExchangeService service,
            String exactSubject,
            boolean unreadOnly,
            int maxSearch,
            BodyType bodyType
    ) throws Exception {

        // Build filter: Subject == exactSubject (and optionally IsRead == false)
        SearchFilter subjectFilter = new SearchFilter.IsEqualTo(EmailMessageSchema.Subject, exactSubject);

        SearchFilter finalFilter = subjectFilter;
        if (unreadOnly) {
            SearchFilter unreadFilter = new SearchFilter.IsEqualTo(EmailMessageSchema.IsRead, false);
            finalFilter = new SearchFilter.SearchFilterCollection(
                    SearchFilter.LogicalOperator.And,
                    subjectFilter,
                    unreadFilter
            );
        }

        // Search Inbox (limit how many items you scan)
        ItemView view = new ItemView(maxSearch);

        // (Optional) If you want "newest first", you can add an OrderBy:
        // view.getOrderBy().add(ItemSchema.DateTimeReceived, SortDirection.Descending);

        FindItemsResults<Item> results = service.findItems(WellKnownFolderName.Inbox, finalFilter, view);

        if (results.getTotalCount() == 0 || results.getItems().isEmpty()) {
            return null;
        }

        // Bind the first matching item to load full properties + body
        PropertySet props = new PropertySet(BasePropertySet.FirstClassProperties);
        props.setRequestedBodyType(bodyType);

        Item first = results.getItems().get(0);
        return EmailMessage.bind(service, first.getId(), props);
    }
}
